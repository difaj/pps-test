<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pay Stars</title>
    <script src="https://a-telegram.stel.com/js/telegram-web-app.js"></script>
    <style>
        :root {
            --glass-bg-dark: rgba(255, 255, 255, 0.08);
            --glass-bg-light: rgba(0, 0, 0, 0.05);
            --glass-border-dark: rgba(255, 255, 255, 0.15);
            --glass-border-light: rgba(0, 0, 0, 0.08);
            --glass-shadow-dark: 0 8px 32px rgba(0, 0, 0, 0.37);
            --glass-shadow-light: 0 8px 32px rgba(0, 0, 0, 0.08);
            --glass-blur: 12px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #121212);
            color: var(--tg-theme-text-color, #ffffff);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        .container {
            text-align: center;
            animation: fadeIn 1s ease-in-out;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 40px 20px;
            box-sizing: border-box;
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 50px;
            color: var(--tg-theme-button-color, #bb86fc);
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .links {
            display: flex;
            flex-direction: column;
            gap: 15px;
            list-style: none;
            padding: 0;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .links li {
            display: flex;
            justify-content: center;
        }

        .glass {
            position: relative;
            background: var(--glass-bg-dark);
            border: 1px solid var(--glass-border-dark);
            border-radius: 16px;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--glass-shadow-dark);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .glass::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg,
                rgba(255,255,255,0.15) 0%,
                transparent 40%,
                rgba(255,255,255,0.05) 100%
            );
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .glass:hover::before {
            opacity: 1;
        }

        .glass:active {
            transform: translateY(1px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        .links li button,
        .clear-history-btn,
        .search-btn {
            position: relative;
            background: var(--glass-bg-dark);
            border: 1px solid var(--glass-border-dark);
            border-radius: 16px;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--glass-shadow-dark);
            color: var(--tg-theme-button-color, #bb86fc);
            font-size: 1.1rem;
            padding: 14px 24px;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
            box-sizing: border-box;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .links li button:hover,
        .clear-history-btn:hover,
        .search-btn:hover {
            background: var(--tg-theme-button-color, #bb86fc);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .nav-bar {
            display: flex;
            padding: 8px;
            background: var(--glass-bg-dark);
            border-top: 1px solid var(--glass-border-dark);
            border-radius: 0;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--glass-shadow-dark);
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            box-sizing: border-box;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-bar::-webkit-scrollbar {
            display: none;
        }

        .nav-bar button.nav-link {
            flex: 1;
            min-width: 70px;
            padding: 12px 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--tg-theme-button-color, #bb86fc);
            background: transparent;
            border: none;
            border-radius: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-bar button.nav-link::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--tg-theme-button-color, #bb86fc);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 14px;
        }

        .nav-bar button.nav-link.active::before {
            opacity: 0.2;
        }

        .nav-bar button.nav-link.active {
            color: #ffffff;
            font-weight: 700;
        }

        .nav-bar button.nav-link:hover::before {
            opacity: 0.15;
        }

        .search-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: nowrap;
        }

        .search-input {
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--glass-border-dark);
            border-radius: 16px;
            background: var(--glass-bg-dark);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            color: var(--tg-theme-text-color, #ffffff);
            width: 100%;
            max-width: 120px;
            box-sizing: border-box;
            box-shadow: var(--glass-shadow-dark);
        }

        .search-btn {
            max-width: 100px;
        }

        .scan-history,
        .nft-result,
        .no-history,
        .no-result {
            margin-top: 20px;
            padding: 16px;
            border-radius: 16px;
            background: var(--glass-bg-dark);
            border: 1px solid var(--glass-border-dark);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            box-shadow: var(--glass-shadow-dark);
        }

        .tg-logo {
            margin-top: 30px;
            opacity: 0.6;
            font-size: 0.8rem;
            color: var(--tg-theme-hint-color, #aaaaaa);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body.light-theme {
            --glass-bg-dark: var(--glass-bg-light);
            --glass-border-dark: var(--glass-border-light);
            --glass-shadow-dark: var(--glass-shadow-light);
        }

        body.light-theme .glass,
        body.light-theme .links li button,
        body.light-theme .clear-history-btn,
        body.light-theme .search-btn,
        body.light-theme .nav-bar,
        body.light-theme .search-input,
        body.light-theme .scan-history,
        body.light-theme .nft-result,
        body.light-theme .no-history,
        body.light-theme .no-result {
            background: var(--glass-bg-light);
            border-color: var(--glass-border-light);
            box-shadow: var(--glass-shadow-light);
        }

        body.light-theme .glass::before {
            background: linear-gradient(135deg,
                rgba(0,0,0,0.08) 0%,
                transparent 40%,
                rgba(0,0,0,0.03) 100%
            );
        }

        html, body {
            -webkit-overflow-scrolling: touch;
        }

        input, textarea, select {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page active" id="main-page">
            <h1>Pay Stars</h1>
            <ul class="links">
                <li><button onclick="PayStarsApp.openLink('https://t.me/stars_telegram_vf')" data-haptic="warning">Our Channel</button></li>
                <li><button onclick="PayStarsApp.openLink('https://t.me/StarsPremiumBot')" data-haptic="warning">Premium for Stars</button></li>
            </ul>
            <div class="tg-logo">Telegram WebApp</div>
        </div>

        <div class="page" id="contact-page">
            <h1>Contact Us</h1>
            <ul class="links">
                <li><button onclick="PayStarsApp.openLink('https://t.me/lakel')" data-haptic="warning">Contact Admin</button></li>
                <li><button onclick="PayStarsApp.openLink('https://t.me/help_stars')" data-haptic="warning">Feedback</button></li>
            </ul>
            <div class="tg-logo">Telegram WebApp</div>
        </div>

        <div class="page" id="scan-history-page">
            <h1>Scan History</h1>
            <div class="scan-history" id="scan-history-table" style="display: none;">
                <table>
                    <thead><tr><th>Date</th><th>Result</th></tr></thead>
                    <tbody id="scan-history-list"></tbody>
                </table>
            </div>
            <div class="no-history" id="no-history-message">You don't have any scan history yet.</div>
            <button class="clear-history-btn" onclick="PayStarsApp.clearScanHistory()" data-haptic="warning">Clear Scan History</button>
            <div class="tg-logo">Telegram WebApp</div>
        </div>

        <div class="page" id="nft-search-page">
            <h1>Search NFT Gifts</h1>
            <div class="search-container">
                <input type="text" id="nft-name-input" placeholder="Name" class="search-input">
                <input type="text" id="nft-number-input" placeholder="Number" class="search-input">
                <button onclick="PayStarsApp.searchNFT()" data-haptic="warning" class="search-btn">Search</button>
            </div>
            <div class="nft-result" id="nft-result" style="display: none;">
                <img id="nft-image" alt="NFT Image" style="max-width: 100%; border-radius: 12px; margin: 10px 0; display: none;">
                <div id="no-image-message" style="display: none;">Photo not available</div>
                <table class="nft-table">
                    <tbody id="nft-info"></tbody>
                </table>
            </div>
            <div class="no-result" id="no-result-message">Enter an NFT name and number to search.</div>
            <div class="tg-logo">Telegram WebApp</div>
        </div>

        <div class="page" id="test-page">
            <h1>Test Features</h1>
            <ul class="links">
                <li><button onclick="PayStarsApp.openLink('tg://nft?slug=aTCuqOAvWUsBAAAAj08P-4gBdtw')" data-haptic="warning">Test Button</button></li>
                <li><button onclick="PayStarsApp.openLink('https://t.me/$qEkvAY4AKEoGAAAA4lfaNB2EbVk')" data-haptic="warning">Make a Payment</button></li>
                <li><button onclick="PayStarsApp.setEmojiStatus(this, '5258115417230016513');" data-haptic="warning">
                    Set Emoji Status <span class="status-feedback"></span>
                </button></li>
                <li><button onclick="PayStarsApp.toggleTheme()" data-haptic="warning">Toggle Theme</button></li>
            </ul>
            <div class="tg-logo">Telegram WebApp</div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-link active" data-page="main-page">Main</button>
        <button class="nav-link" data-page="contact-page">Contact</button>
        <button class="nav-link" data-page="scan-history-page">History</button>
        <button class="nav-link" data-page="nft-search-page">NFT</button>
        <button class="nav-link" onclick="PayStarsApp.showScanQrPopup(true);" data-haptic="warning">QR Scan</button>
        <button class="nav-link" data-page="test-page">Test</button>
    </div>

    <script>
        const PayStarsApp = {
            initDone: false,
            webApp: null,
            currentPage: 'main-page',
            userId: null,

            init: function() {
                if (this.initDone) return true;
                if (window.Telegram && window.Telegram.WebApp) {
                    this.webApp = Telegram.WebApp;
                    this.webApp.ready();
                    this.webApp.expand();
                    this.initDone = true;
                    const user = this.webApp.initDataUnsafe?.user;
                    if (user) this.userId = user.id;
                    if (window.location.search) history.replaceState({}, '', window.location.pathname);
                    return true;
                }
                return false;
            },

            openLink: function(url) {
                if (!this.init()) return;
                this.webApp.HapticFeedback.impactOccurred('light');
                try { this.webApp.openLink(url); } catch (e) { window.location.href = url; }
            },

            setEmojiStatus: function(el, id) {
                const fb = el.querySelector('.status-feedback');
                if (!this.init()) { this.showFeedback(fb, 'WebApp not available', 3000); return; }
                if (!this.webApp.isVersionAtLeast('8.0')) { this.showFeedback(fb, 'Update Telegram', 3000); return; }
                this.webApp.HapticFeedback.impactOccurred('light');
                try {
                    this.webApp.setEmojiStatus(id, null, (s) => {
                        this.showFeedback(fb, s ? 'Status set' : 'Failed', s ? 2000 : 3000);
                        this.webApp.HapticFeedback.notificationOccurred(s ? 'success' : 'error');
                    });
                } catch (e) { this.showFeedback(fb, 'Error', 3000); }
            },

            showScanQrPopup: function(links) {
                if (!this.init() || !this.webApp.isVersionAtLeast('6.7')) return;
                this.webApp.HapticFeedback.impactOccurred('light');
                try {
                    this.webApp.showScanQrPopup({ text: links ? 'Scan link QR' : 'Scan QR' }, (res) => {
                        this.webApp.closeScanQrPopup();
                        if (links && res.startsWith('http')) this.openLink(res);
                        this.saveScanHistory(res);
                        if (this.currentPage === 'scan-history-page') this.showScanHistory();
                        return true;
                    });
                } catch (e) {}
            },

            saveScanHistory: function(res) {
                if (!this.userId) return;
                const k = `scan_history_${this.userId}`;
                this.webApp.DeviceStorage.getItem(k, (e, v) => {
                    let h = [];
                    if (!e && v) try { const p = JSON.parse(v); if (Array.isArray(p)) h = p; } catch (e) {}
                    h.push({ timestamp: new Date().toISOString(), result: res });
                    this.webApp.DeviceStorage.setItem(k, JSON.stringify(h), () => {});
                });
            },

            showScanHistory: function() {
                if (!this.userId) return;
                const k = `scan_history_${this.userId}`;
                const t = document.getElementById('scan-history-table');
                const l = document.getElementById('scan-history-list');
                const m = document.getElementById('no-history-message');
                l.innerHTML = '';
                this.webApp.DeviceStorage.getItem(k, (e, v) => {
                    if (e || !v || !Array.isArray(JSON.parse(v || '[]')) || (JSON.parse(v || '[]')).length === 0) {
                        t.style.display = 'none'; m.style.display = 'block'; m.textContent = "You don't have any scan history yet."; return;
                    }
                    try {
                        const h = JSON.parse(v);
                        t.style.display = 'block'; m.style.display = 'none';
                        h.forEach(i => {
                            if (i.timestamp && i.result) {
                                const d = new Date(i.timestamp);
                                const fd = `${d.getUTCDate().toString().padStart(2,'0')}.${(d.getUTCMonth()+1).toString().padStart(2,'0')}.${d.getUTCFullYear()}`;
                                const ft = `${d.getUTCHours().toString().padStart(2,'0')}:${d.getUTCMinutes().toString().padStart(2,'0')}:${d.getUTCSeconds().toString().padStart(2,'0')}`;
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td><div class="date-time">${fd}<br>${ft}</div></td><td>${i.result}</td>`;
                                l.appendChild(tr);
                            }
                        });
                    } catch (e) { t.style.display = 'none'; m.style.display = 'block'; m.textContent = 'Error loading history'; }
                });
            },

            clearScanHistory: function() {
                if (!this.userId) return;
                this.webApp.showConfirm('Clear history?', c => {
                    if (c) {
                        this.webApp.DeviceStorage.removeItem(`scan_history_${this.userId}`, () => this.showScanHistory());
                    }
                });
            },

            searchNFT: async function() {
                if (!this.init()) return;
                const n = document.getElementById('nft-name-input').value.trim();
                const num = document.getElementById('nft-number-input').value.trim();
                const msg = document.getElementById('no-result-message');
                if (!n || !num) { msg.textContent = 'Enter name and number'; msg.style.display = 'block'; return; }

                const input = `${n}-${num}`;
                const res = document.getElementById('nft-result');
                const info = document.getElementById('nft-info');
                const img = document.getElementById('nft-image');
                const noImg = document.getElementById('no-image-message');
                res.style.display = 'none'; msg.style.display = 'block'; msg.textContent = 'Searching...';
                img.style.display = 'none'; noImg.style.display = 'none';

                let loaded = false;
                const max = 3; let a = 0;
                while (a < max) {
                    try {
                        const p = 'https://api.allorigins.win/raw?url=';
                        const u = `${p}${encodeURIComponent(`https://a-ttgme.stel.com/nft/${input}`)}`;
                        const iurl = `https://tnft.stel.com/gift/${n}-${num}.webp`;

                        await new Promise(r => {
                            img.src = iurl;
                            img.onload = () => { loaded = true; r(); };
                            img.onerror = () => { loaded = false; r(); };
                            setTimeout(r, 5000);
                        });

                        const r = await fetch(u, { headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                            'Referer': 'https://a-ttgme.stel.com/'
                        }});
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        const t = await r.text();
                        const d = new DOMParser().parseFromString(t, 'text/html');
                        const tbl = d.querySelector('.tgme_gift_table');
                        if (!tbl) throw new Error('No data');

                        const data = {};
                        tbl.querySelectorAll('tr').forEach(row => {
                            const th = row.querySelector('th')?.textContent.trim();
                            const td = row.querySelector('td');
                            if (th && td) {
                                if (th === 'Owner') {
                                    const clone = td.cloneNode(true);
                                    clone.querySelector('.tgme_gift_owner_photo')?.remove();
                                    const link = clone.querySelector('a');
                                    const name = link ? link.textContent.trim() : clone.textContent.trim() || 'Anonymous';
                                    if (link) {
                                        const h = link.getAttribute('href');
                                        data[th] = `<span class="cat-avatar">User</span><a href="${h}" onclick="PayStarsApp.openLink('${h}');return false;">${name}</a>`;
                                    } else data[th] = `<span class="cat-avatar">User</span>${name}`;
                                } else data[th] = td.innerHTML.trim();
                            }
                        });

                        data['Model'] = 'Choco Dream <span class="percent-bubble">15%</span>';
                        data['Backdrop'] = 'French Blue <span class="percent-bubble">1.8%</span>';
                        data['Symbol'] = 'Pig <span class="percent-bubble">30%</span>';

                        info.innerHTML = `
                            <tr><th>Owner</th><td>${data['Owner'] || '<span class="cat-avatar">User</span>Anonymous'}</td></tr>
                            <tr><th>Model</th><td>${data['Model'] || 'N/A'}</td></tr>
                            <tr><th>Backdrop</th><td>${data['Backdrop'] || 'N/A'}</td></tr>
                            <tr><th>Symbol</th><td>${data['Symbol'] || 'N/A'}</td></tr>
                            <tr><th>Quantity</th><td>${data['Quantity'] || 'N/A'}</td></tr>
                        `;

                        res.style.display = 'block'; msg.style.display = 'none';
                        document.getElementById('nft-name-input').value = '';
                        document.getElementById('nft-number-input').value = '';
                        img.style.display = loaded ? 'block' : 'none';
                        this.webApp.HapticFeedback.notificationOccurred('success');
                        return;
                    } catch (e) {
                        a++;
                        if (a >= max) {
                            msg.textContent = 'Not found or connection error';
                            res.style.display = 'block';
                            this.webApp.HapticFeedback.notificationOccurred('error');
                        } else await new Promise(r => setTimeout(r, 1000 * a));
                    }
                }
            },

            showFeedback: function(el, msg, dur) {
                if (!el) return;
                el.textContent = msg; el.style.display = 'block';
                setTimeout(() => { el.textContent = ''; el.style.display = 'none'; }, dur);
            },

            switchPage: function(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const pg = document.getElementById(id); if (pg) pg.classList.add('active');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const nl = document.querySelector(`.nav-link[data-page="${id}"]`); if (nl) nl.classList.add('active');
                this.currentPage = id;
                this.webApp.HapticFeedback.impactOccurred('light');
                history.pushState({ page: id }, '', window.location.pathname);
                if (id === 'scan-history-page') this.showScanHistory();
            },

            toggleTheme: function() {
                if (!this.init()) return;
                const light = document.body.classList.toggle('light-theme');
                const theme = light ? 'light' : 'dark';
                this.webApp.HapticFeedback.impactOccurred('light');

                const colors = light ? {
                    bg: '#ffffff', text: '#333333', btn: '#6200ea', btnText: '#ffffff',
                    sec: 'rgba(0,0,0,0.1)', hint: '#666666'
                } : {
                    bg: '#121212', text: '#ffffff', btn: '#bb86fc', btnText: '#ffffff',
                    sec: 'rgba(0,0,0,0.2)', hint: '#aaaaaa'
                };

                Object.entries(colors).forEach(([k, v]) => {
                    document.body.style.setProperty(`--tg-theme-${k === 'bg' ? 'bg-color' : k === 'sec' ? 'secondary-bg-color' : k === 'btnText' ? 'button-text-color' : k === 'btn' ? 'button-color' : k === 'hint' ? 'hint-color' : 'text-color'}`, v);
                });

                if (this.userId) this.webApp.DeviceStorage.setItem(`theme_${this.userId}`, theme, () => {});
            },

            loadTheme: function() {
                if (!this.userId || !this.webApp) return;
                this.webApp.DeviceStorage.getItem(`theme_${this.userId}`, (e, v) => {
                    const light = v === 'light';
                    document.body.classList.toggle('light-theme', light);
                    const colors = light ? {
                        bg: '#ffffff', text: '#333333', btn: '#6200ea', btnText: '#ffffff',
                        sec: 'rgba(0,0,0,0.1)', hint: '#666666'
                    } : {
                        bg: '#121212', text: '#ffffff', btn: '#bb86fc', btnText: '#ffffff',
                        sec: 'rgba(0,0,0,0.2)', hint: '#aaaaaa'
                    };
                    Object.entries(colors).forEach(([k, v]) => {
                        document.body.style.setProperty(`--tg-theme-${k === 'bg' ? 'bg-color' : k === 'sec' ? 'secondary-bg-color' : k === 'btnText' ? 'button-text-color' : k === 'btn' ? 'button-color' : k === 'hint' ? 'hint-color' : 'text-color'}`, v);
                    });
                });
            },

            setupHapticFeedback: function() {
                document.querySelectorAll('[data-haptic]').forEach(el => {
                    el.addEventListener('click', () => {
                        if (this.webApp) this.webApp.HapticFeedback.notificationOccurred(el.dataset.haptic);
                    });
                });
            },

            setupNavigation: function() {
                document.querySelectorAll('.nav-link').forEach(b => {
                    b.removeEventListener('click', b._handler);
                    if (b.dataset.page) {
                        b._handler = () => this.switchPage(b.dataset.page);
                    } else {
                        b._handler = () => b.onclick();
                    }
                    b.addEventListener('click', b._handler);
                    b.addEventListener('contextmenu', e => e.preventDefault());
                });
            },

            setupButtonContextMenuPrevention: function() {
                document.querySelectorAll('.links button, .clear-history-btn').forEach(b => {
                    b.addEventListener('contextmenu', e => e.preventDefault());
                });
            }
        };

        window.addEventListener('popstate', e => PayStarsApp.switchPage(e.state?.page || 'main-page'));

        document.addEventListener('DOMContentLoaded', () => {
            PayStarsApp.init();
            PayStarsApp.setupHapticFeedback();
            PayStarsApp.setupNavigation();
            PayStarsApp.setupButtonContextMenuPrevention();
            PayStarsApp.switchPage('main-page');
            PayStarsApp.loadTheme();

            document.addEventListener('gesturestart', e => e.preventDefault());
            document.addEventListener('touchmove', e => { if (e.scale !== 1) e.preventDefault(); }, { passive: false });
        });
    </script>
</body>
</html>
